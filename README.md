# testbox

## Утилита (на базе Docker SDK) для интеграционных тестов

---
**1. Задачи, которые выполняет данная утилита:**

- подключится к `docker`;
- скачает нужные образы, запустит контейнеры зависимостей;
- соберет образ тестируемого приложения, запустит его как контейнер и проведет над ним серию тестов.

 > *Это часто используемый прием, для разгрузки разработчиков и избежания необходимости поднимать все руками.*
 >
 > Тесты будут заключаться в запросе различных ендпоинтов приложения и проверки ответа на соответствие различным правилам.

**2. Конфигурация**

> Для конфигурирования приложения предлагается использовать файл конфигурации в **yaml** формате:

- `ContainerName` **(обязательное)** *определит имя контейнера тестируемого приложения.*

- `Dockerfile` **(обязательное)** *определит путь к файлу из которого мы будем строить наш docker-image (имя image будет складываться из ContainerName-рандомное число).*
    > Для того, чтобы создать образ на основе **Dockerfile**, для начала потребуется создать буфер, в который будет записан виртуальный архив (**tar**), сформированный из данных вышеупомянутого файла.  
    >
    > Впоследствии, этот буфер будет использован для создания образа как контекст, а ридер этого буфера будет передан аргументом как опция построения образа - [полезная ссылка](https://www.loginradius.com/blog/async/build-push-docker-images-golang/)

- `Dependencies` **(опционально)** *определяет сервисы от которых зависит тестируемое приложение, например база данных или кеш, брокер сообщений и т.п..*

- `Environment` **(опционально)** определяет переменные окружения для передачи в контейнер с тестируемым приложением..
    >Формат записи: `DB_IP=${db:network_address}` - **DB_IP** - имя переменной окружения, `${}` - означает вычисляемое значение.
    >
    > **Правило вычисления:**
    > - `db:network_address` - **db** - имя контейнера зависимости **(Dependencies.[0].name)**,
    > - `network_address` - атрибут контейнера, *(в данном случае сетевой адрес)*. \
    > Тогда если у контейнера с именем *db* параметр **network_address = 192.168.1.10**, тогда переменная **DB_IP** внутри тестируемого контейнера будет иметь значние **192.168.1.10**

- `Tests` **(обязательное)** *определит массив тестов для тестируемого сервиса.*
  
    > **Каждый тест содержит в себе следующие поля:**
    >
    > - `Name` - (обязательное) имя теста
    >
    > - `URL` - (обязательное) http путь по которому обращается наш тест
    >
    > - `QueryType` - (обязательное) тип запроса (GET, POST, PUT, DELETE)
    >
    > - `Query` - (опциональное) тело запроса, если его нет, то тело запроса пустое
    >
    > - `ExpectedCode` - (опциональное) правило проверки ответа, ожидаемый HTTP код
    >
    > - `ResponseContains` - (опциональное) правило проверки ответа, тело ответа должно содержать эту строку

**2. Дополнение** *(часть для микросервиса)*

> `main` функция должна находиться в файле `Exercises/7.Docker/3/cmd/testbox/main.go` потому что настроен интеграционный тест в котором будет производиться сборка утилиты и ее запуск с конфигом, который лежит в папке `Exercises/7.Docker/3/configs/`, удалять из этой папки конфиги нельзя (сломается тест)

> Приложение должно включать в себя валидатор, который должен отдавать осмысленные ошибки. Из джентльменского набора:
>
  > - Неверный **YAML** нельзя считать **YAML**
  >
  > - Отсутствует файл конфигурации
  >
  > - Не заполнены какие либо обязательные поля
  >
  > - Не получается связаться с докером
